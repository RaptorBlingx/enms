{% extends "base.html" %}

{% block title %}Baseline Training - EnMS Analytics{% endblock %}

{% block extra_css %}
<style>
    .driver-selection {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .driver-checkbox {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 2px solid #dee2e6;
        border-radius: 6px;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .driver-checkbox:hover {
        border-color: #0d6efd;
        background-color: #f0f7ff;
    }
    
    .driver-checkbox input:checked ~ label {
        font-weight: 600;
        color: #0d6efd;
    }
    
    .feature-description {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .model-results {
        display: none;
    }
    
    .model-results.show {
        display: block;
    }
    
    .coefficient-bar {
        height: 30px;
        background: linear-gradient(90deg, #0d6efd 0%, #0dcaf0 100%);
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding-left: 10px;
        color: white;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6">Energy Baseline Training</h1>
        <p class="text-muted">ISO 50001-compliant baseline regression with driver selection</p>
    </div>
</div>

<!-- Training Form -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Training Configuration</h5>
            </div>
            <div class="card-body">
                <form id="training-form">
                    <!-- Machine Selection -->
                    <div class="mb-3">
                        <label for="machine-select" class="form-label">Machine</label>
                        <select class="form-select" id="machine-select" required>
                            <option value="">Select a machine...</option>
                            <option value="c0000000-0000-0000-0000-000000000001">Compressor-1</option>
                            <option value="h0000000-0000-0000-0000-000000000001">HVAC-1</option>
                            <option value="m0000000-0000-0000-0000-000000000001">Conveyor-1</option>
                        </select>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="mb-3">
                        <label for="start-date" class="form-label">Training Start Date</label>
                        <input type="date" class="form-control" id="start-date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="end-date" class="form-label">Training End Date</label>
                        <input type="date" class="form-control" id="end-date" required>
                    </div>
                    
                    <!-- Driver Selection -->
                    <div class="driver-selection">
                        <h6 class="mb-3">Select Drivers (Minimum 3)</h6>
                        <small class="text-muted d-block mb-3">Choose factors that influence energy consumption</small>
                        
                        <div class="driver-checkbox">
                            <div class="form-check">
                                <input class="form-check-input driver-input" type="checkbox" value="total_production_count" id="driver-production" checked>
                                <label class="form-check-label" for="driver-production">
                                    <strong>Production Count</strong>
                                    <div class="feature-description">Total units produced per hour</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="driver-checkbox">
                            <div class="form-check">
                                <input class="form-check-input driver-input" type="checkbox" value="avg_outdoor_temp_c" id="driver-outdoor-temp" checked>
                                <label class="form-check-label" for="driver-outdoor-temp">
                                    <strong>Outdoor Temperature</strong>
                                    <div class="feature-description">External temperature in °C</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="driver-checkbox">
                            <div class="form-check">
                                <input class="form-check-input driver-input" type="checkbox" value="avg_pressure_bar" id="driver-pressure" checked>
                                <label class="form-check-label" for="driver-pressure">
                                    <strong>Pressure</strong>
                                    <div class="feature-description">Average pressure in bar</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="driver-checkbox">
                            <div class="form-check">
                                <input class="form-check-input driver-input" type="checkbox" value="avg_throughput_units_per_hour" id="driver-throughput">
                                <label class="form-check-label" for="driver-throughput">
                                    <strong>Throughput</strong>
                                    <div class="feature-description">Average throughput units per hour</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="driver-checkbox">
                            <div class="form-check">
                                <input class="form-check-input driver-input" type="checkbox" value="avg_machine_temp_c" id="driver-machine-temp">
                                <label class="form-check-label" for="driver-machine-temp">
                                    <strong>Machine Temperature</strong>
                                    <div class="feature-description">Average machine temperature in °C</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="driver-checkbox">
                            <div class="form-check">
                                <input class="form-check-input driver-input" type="checkbox" value="avg_load_factor" id="driver-load-factor">
                                <label class="form-check-label" for="driver-load-factor">
                                    <strong>Load Factor</strong>
                                    <div class="feature-description">Average machine load factor</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3" id="driver-warning" style="display: none;">
                            <small>Please select at least 3 drivers for training.</small>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-100" id="train-btn">
                        <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                            <path d="M13 2.5a1.5 1.5 0 0 1 3 0v11a1.5 1.5 0 0 1-3 0v-.214c-2.162-1.241-4.49-1.843-6.912-2.083l.405 2.712A1 1 0 0 1 5.51 15.1h-.548a1 1 0 0 1-.916-.599l-1.85-3.49a68.14 68.14 0 0 0-.202-.003A2.014 2.014 0 0 1 0 9V7a2.02 2.02 0 0 1 1.992-2.013 74.663 74.663 0 0 0 2.483-.075c3.043-.154 6.148-.849 8.525-2.199V2.5zm1 0v11a.5.5 0 0 0 1 0v-11a.5.5 0 0 0-1 0zm-1 1.35c-2.344 1.205-5.209 1.842-8 2.033v4.233c.18.01.359.022.537.036 2.568.189 5.093.744 7.463 1.993V3.85z"/>
                        </svg>
                        Train Baseline Model
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Existing Models -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Existing Models</h5>
            </div>
            <div class="card-body" id="existing-models-container">
                <p class="text-muted">Select a machine to view models</p>
            </div>
        </div>
    </div>
    
    <!-- Results Area -->
    <div class="col-md-8">
        <!-- Training Progress -->
        <div id="training-progress" style="display: none;">
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Training...</span>
                    </div>
                    <h5>Training Model...</h5>
                    <p class="text-muted">This may take a few moments</p>
                </div>
            </div>
        </div>
        
        <!-- Model Results -->
        <div id="model-results" class="model-results">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Model Performance</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="stat-card">
                                <div class="stat-value text-success" id="r-squared-value">-</div>
                                <div class="stat-label">R² Score</div>
                                <small class="text-muted d-block mt-2">Goodness of fit (>0.80 is good)</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-card">
                                <div class="stat-value text-info" id="rmse-value">-</div>
                                <div class="stat-label">RMSE (kWh)</div>
                                <small class="text-muted d-block mt-2">Root mean squared error</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-card">
                                <div class="stat-value text-primary" id="samples-value">-</div>
                                <div class="stat-label">Training Samples</div>
                                <small class="text-muted d-block mt-2">Data points used</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quality-alert"></div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Model Coefficients</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Impact of each driver on energy consumption</p>
                    <div id="coefficients-container"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Actual vs. Predicted Energy</h5>
                </div>
                <div class="card-body">
                    <canvas id="comparison-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Initial Message -->
        <div id="initial-message" class="card">
            <div class="card-body text-center py-5">
                <svg width="64" height="64" fill="currentColor" class="text-muted mb-3" viewBox="0 0 16 16">
                    <path d="M0 0h1v15h15v1H0V0Zm10 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4.9l-3.613 4.417a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61L13.445 4H10.5a.5.5 0 0 1-.5-.5Z"/>
                </svg>
                <h5>No Model Trained Yet</h5>
                <p class="text-muted">Select a machine, date range, and drivers to train a baseline model</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let comparisonChart = null;
    
    // Load machines on page load
    async function loadMachines() {
        try {
            const response = await axios.get(`${API_BASE}/machines`, {
                params: { is_active: true }
            });
            const select = document.getElementById('machine-select');
            const machines = response.data || [];
            
            // Keep the default "Select a machine..." option
            select.innerHTML = '<option value="">Select a machine...</option>';
            
            // Add machines from API
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.name} (${machine.type})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading machines:', error);
            // Keep hardcoded options as fallback
        }
    }
    
    // Initialize page
    loadMachines();
    
    // Set default date range (last 30 days)
    document.getElementById('end-date').valueAsDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    document.getElementById('start-date').valueAsDate = startDate;
    
    // Driver validation
    document.querySelectorAll('.driver-input').forEach(checkbox => {
        checkbox.addEventListener('change', validateDrivers);
    });
    
    function validateDrivers() {
        const checkedCount = document.querySelectorAll('.driver-input:checked').length;
        const warning = document.getElementById('driver-warning');
        const submitBtn = document.getElementById('train-btn');
        
        if (checkedCount < 3) {
            warning.style.display = 'block';
            submitBtn.disabled = true;
        } else {
            warning.style.display = 'none';
            submitBtn.disabled = false;
        }
    }
    
    // Load existing models when machine is selected
    document.getElementById('machine-select').addEventListener('change', async (e) => {
        const machineId = e.target.value;
        if (!machineId) return;
        
        try {
            const response = await axios.get(`${API_BASE}/baseline/models`, {
                params: { machine_id: machineId }
            });
            displayExistingModels(response.data.models || response.data);
        } catch (error) {
            console.error('Error loading models:', error);
        }
    });
    
    function displayExistingModels(data) {
        const container = document.getElementById('existing-models-container');
        const models = Array.isArray(data) ? data : (data.models || []);
        
        if (!models || models.length === 0) {
            container.innerHTML = '<p class="text-muted">No models found for this machine</p>';
            return;
        }
        
        let html = '<div class="list-group">';
        models.forEach(model => {
            const active = model.is_active ? '<span class="badge bg-success">Active</span>' : '';
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${model.model_name} ${active}</h6>
                            <small class="text-muted">R² = ${model.r_squared?.toFixed(4) || 'N/A'}</small>
                        </div>
                        <small class="text-muted">${formatDate(model.created_at)}</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    // Form submission
    document.getElementById('training-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const machineId = document.getElementById('machine-select').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // Get selected drivers
        const drivers = Array.from(document.querySelectorAll('.driver-input:checked'))
            .map(cb => cb.value);
        
        if (drivers.length < 3) {
            alert('Please select at least 3 drivers');
            return;
        }
        
        // Show progress
        document.getElementById('initial-message').style.display = 'none';
        document.getElementById('model-results').classList.remove('show');
        document.getElementById('training-progress').style.display = 'block';
        
        try {
            const response = await axios.post(`${API_BASE}/baseline/train`, {
                machine_id: machineId,
                start_date: startDate + 'T00:00:00Z',
                end_date: endDate + 'T23:59:59Z',
                drivers: drivers
            });
            
            displayModelResults(response.data);
            
            // Reload existing models
            const modelsResponse = await axios.get(`${API_BASE}/baseline/models`, {
                params: { machine_id: machineId }
            });
            displayExistingModels(modelsResponse.data.models || modelsResponse.data);
            
        } catch (error) {
            alert('Training failed: ' + (error.response?.data?.message || error.message));
            document.getElementById('initial-message').style.display = 'block';
        } finally {
            document.getElementById('training-progress').style.display = 'none';
        }
    });
    
    function displayModelResults(data) {
        document.getElementById('model-results').classList.add('show');
        
        // Performance metrics
        document.getElementById('r-squared-value').textContent = data.r_squared.toFixed(4);
        document.getElementById('rmse-value').textContent = data.rmse.toFixed(3);
        document.getElementById('samples-value').textContent = data.training_samples;
        
        // Quality alert
        const qualityAlert = document.getElementById('quality-alert');
        if (data.meets_quality_threshold) {
            qualityAlert.innerHTML = '<div class="alert alert-success"><strong>✓ Model Quality:</strong> Meets ISO 50001 threshold (R² > 0.80)</div>';
        } else {
            qualityAlert.innerHTML = '<div class="alert alert-warning"><strong>⚠ Model Quality:</strong> Below recommended threshold. Consider more training data.</div>';
        }
        
        // Coefficients
        const coeffContainer = document.getElementById('coefficients-container');
        let coeffHtml = '';
        
        Object.entries(data.coefficients).forEach(([feature, value]) => {
            const absValue = Math.abs(value);
            const maxWidth = Math.min(absValue * 20, 100); // Scale for visualization
            coeffHtml += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>${feature}</span>
                        <strong>${value.toFixed(4)}</strong>
                    </div>
                    <div class="coefficient-bar" style="width: ${maxWidth}%">
                        ${value > 0 ? 'Increases' : 'Decreases'} energy
                    </div>
                </div>
            `;
        });
        
        coeffContainer.innerHTML = coeffHtml;
        
        // Chart (mock data - in production, get actual vs predicted from API)
        createComparisonChart();
    }
    
    function createComparisonChart() {
        const ctx = document.getElementById('comparison-chart');
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        // Mock data for visualization
        const hours = Array.from({length: 24}, (_, i) => i);
        
        comparisonChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hours,
                datasets: [
                    {
                        label: 'Actual Energy',
                        data: hours.map(h => 30 + Math.sin(h / 4) * 10 + Math.random() * 5),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Predicted Energy',
                        data: hours.map(h => 30 + Math.sin(h / 4) * 10),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Energy (kWh)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}