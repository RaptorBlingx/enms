<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Flow - Sankey Diagram | EnMS</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- D3 Sankey Plugin -->
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 2rem auto;
            padding: 2rem;
            max-width: 1400px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #2d3748;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .controls-panel {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .metric-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }
        
        .metric-card p {
            margin: 0;
            opacity: 0.9;
        }
        
        #sankey-chart {
            background: #fafafa;
            border-radius: 12px;
            padding: 2rem;
            min-height: 600px;
            position: relative;
        }
        
        .node rect {
            cursor: pointer;
            stroke: #000;
            stroke-width: 1px;
        }
        
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-weight: 600;
        }
        
        .link {
            fill: none;
            stroke-opacity: 0.3;
        }
        
        .link:hover {
            stroke-opacity: 0.6;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 4rem;
        }
        
        .spinner-border {
            width: 4rem;
            height: 4rem;
            color: #667eea;
        }
        
        .legend {
            margin-top: 2rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .legend-item {
            display: inline-block;
            margin-right: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="bi bi-diagram-3"></i>
                Energy Flow Visualization
            </h1>
            <p>Sankey diagram showing energy distribution across your facility</p>
        </div>
        
        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label"><strong>Start Date</strong></label>
                    <input type="date" id="start-date" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>End Date</strong></label>
                    <input type="date" id="end-date" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>Min Energy (kWh)</strong></label>
                    <input type="number" id="min-energy" class="form-control" value="0" min="0" step="10">
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>&nbsp;</strong></label>
                    <button class="btn btn-primary w-100" onclick="loadSankeyData()">
                        <i class="bi bi-arrow-repeat"></i> Update
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Metrics Row -->
        <div class="row mb-4" id="metrics-row">
            <div class="col-md-3">
                <div class="metric-card">
                    <h3 id="total-energy">-</h3>
                    <p>Total Energy (kWh)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="factory-count">-</h3>
                    <p>Factories</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="dept-count">-</h3>
                    <p>Departments</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3 id="machine-count">-</h3>
                    <p>Machines</p>
                </div>
            </div>
        </div>
        
        <!-- Sankey Chart -->
        <div id="sankey-chart">
            <div class="loading-spinner">
                <div class="spinner-border" role="status"></div>
                <p class="mt-3">Loading energy flow data...</p>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
            <strong>Legend:</strong>
            <div class="legend-item">
                <span class="legend-color" style="background: #667eea;"></span>
                Grid
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #f093fb;"></span>
                Factory
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #4facfe;"></span>
                Department
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #43e97b;"></span>
                Machine
            </div>
        </div>
        
        <!-- Back Button -->
        <div class="text-center mt-4">
            <a href="/ui/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ====================================================================
        // CONFIGURATION
        // ====================================================================
        
        // API Base URL - detect if accessed through nginx proxy or directly
        const API_BASE = window.location.port === '8001' ? '/api/v1' : '/api/analytics/api/v1';
        const API_BASE_URL = `${API_BASE}/sankey`;
        
        // Color scheme for different levels
        const LEVEL_COLORS = {
            0: '#667eea',  // Grid - Purple
            1: '#f093fb',  // Factory - Pink
            2: '#4facfe',  // Department - Blue
            3: '#43e97b'   // Machine - Green
        };
        
        // ====================================================================
        // INITIALIZATION
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('end-date').valueAsDate = endDate;
            document.getElementById('start-date').valueAsDate = startDate;
            
            // Load initial data
            loadSankeyData();
        });
        
        // ====================================================================
        // DATA LOADING
        // ====================================================================
        
        async function loadSankeyData() {
            try {
                // Get parameters
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const minEnergy = document.getElementById('min-energy').value;
                
                // Build query string
                const params = new URLSearchParams({
                    start_date: startDate + 'T00:00:00Z',
                    end_date: endDate + 'T23:59:59Z',
                    min_energy_kwh: minEnergy
                });
                
                // Show loading
                document.getElementById('sankey-chart').innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-3">Loading energy flow data...</p>
                    </div>
                `;
                
                // Fetch data
                const response = await fetch(`${API_BASE_URL}/data?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update metrics
                updateMetrics(data);
                
                // Draw Sankey diagram
                drawSankey(data);
                
            } catch (error) {
                console.error('Error loading Sankey data:', error);
                document.getElementById('sankey-chart').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Error loading data:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        // ====================================================================
        // METRICS UPDATE
        // ====================================================================
        
        function updateMetrics(data) {
            document.getElementById('total-energy').textContent = 
                data.total_energy_kwh.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('factory-count').textContent = data.factory_count;
            document.getElementById('dept-count').textContent = data.department_count;
            document.getElementById('machine-count').textContent = data.machine_count;
        }
        
        // ====================================================================
        // SANKEY DIAGRAM RENDERING
        // ====================================================================
        
        function drawSankey(data) {
            // Clear previous chart
            document.getElementById('sankey-chart').innerHTML = '';
            
            // Get container dimensions
            const container = document.getElementById('sankey-chart');
            const width = container.clientWidth - 40;
            const height = Math.max(600, data.nodes.length * 20);
            
            // Create SVG
            const svg = d3.select('#sankey-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create Sankey generator
            const sankey = d3.sankey()
                .nodeId(d => d.id)
                .nodeWidth(20)
                .nodePadding(10)
                .extent([[20, 20], [width - 20, height - 20]]);
            
            // Transform data for D3
            const graph = {
                nodes: data.nodes.map(n => ({...n})),
                links: data.links.map(l => ({...l}))
            };
            
            // Generate Sankey layout
            const {nodes, links} = sankey(graph);
            
            // Draw links
            const link = svg.append('g')
                .selectAll('.link')
                .data(links)
                .join('path')
                .attr('class', 'link')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', d => LEVEL_COLORS[d.source.level])
                .attr('stroke-width', d => Math.max(1, d.width))
                .on('mouseover', function(event, d) {
                    showTooltip(event, `
                        <strong>${d.source.name} → ${d.target.name}</strong><br>
                        Energy: ${d.value.toLocaleString()} kWh<br>
                        ${d.percentage}% of ${d.source.name}
                    `);
                    d3.select(this).attr('stroke-opacity', 0.6);
                })
                .on('mouseout', function() {
                    hideTooltip();
                    d3.select(this).attr('stroke-opacity', 0.3);
                });
            
            // Draw nodes
            const node = svg.append('g')
                .selectAll('.node')
                .data(nodes)
                .join('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);
            
            // Node rectangles
            node.append('rect')
                .attr('height', d => d.y1 - d.y0)
                .attr('width', sankey.nodeWidth())
                .attr('fill', d => LEVEL_COLORS[d.level])
                .attr('opacity', 0.9)
                .on('mouseover', function(event, d) {
                    const incomingEnergy = d.targetLinks.reduce((sum, l) => sum + l.value, 0);
                    const outgoingEnergy = d.sourceLinks.reduce((sum, l) => sum + l.value, 0);
                    
                    showTooltip(event, `
                        <strong>${d.name}</strong><br>
                        Level: ${['Grid', 'Factory', 'Department', 'Machine'][d.level]}<br>
                        ${incomingEnergy > 0 ? `Input: ${incomingEnergy.toLocaleString()} kWh<br>` : ''}
                        ${outgoingEnergy > 0 ? `Output: ${outgoingEnergy.toLocaleString()} kWh` : ''}
                    `);
                    d3.select(this).attr('opacity', 1);
                })
                .on('mouseout', function() {
                    hideTooltip();
                    d3.select(this).attr('opacity', 0.9);
                });
            
            // Node labels
            node.append('text')
                .attr('x', d => d.x0 < width / 2 ? sankey.nodeWidth() + 6 : -6)
                .attr('y', d => (d.y1 - d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
                .text(d => d.name)
                .attr('fill', '#2d3748');
        }
        
        // ====================================================================
        // TOOLTIP FUNCTIONS
        // ====================================================================
        
        function showTooltip(event, html) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = html;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }
    </script>
</body>
</html>