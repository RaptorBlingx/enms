<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Heatmap | EnMS</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 2rem auto;
            padding: 2rem;
            max-width: 1400px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #2d3748;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .controls-panel {
            background: #f7fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .metric-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }
        
        .metric-card p {
            margin: 0;
            opacity: 0.9;
        }
        
        .chart-container {
            background: #fafafa;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .patterns-panel {
            background: #fff5e6;
            border-left: 4px solid #ff9800;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .patterns-panel h5 {
            color: #e65100;
            margin-bottom: 1rem;
        }
        
        .pattern-item {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .pattern-item i {
            color: #ff9800;
            margin-right: 0.5rem;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 4rem;
        }
        
        .spinner-border {
            width: 4rem;
            height: 4rem;
            color: #667eea;
        }
        
        .btn-group-toggle .btn {
            padding: 0.5rem 1.5rem;
        }
        
        .btn-group-toggle .btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="bi bi-grid-3x3-gap"></i>
                Anomaly Pattern Heatmap
            </h1>
            <p>Identify when and where anomalies occur most frequently</p>
        </div>
        
        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label"><strong>View Type</strong></label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="view-type" id="hourly-view" value="hourly" checked>
                        <label class="btn btn-outline-primary" for="hourly-view">Hourly</label>
                        
                        <input type="radio" class="btn-check" name="view-type" id="daily-view" value="daily">
                        <label class="btn btn-outline-primary" for="daily-view">Daily</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label"><strong>Start Date</strong></label>
                    <input type="date" id="start-date" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label"><strong>End Date</strong></label>
                    <input type="date" id="end-date" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label"><strong>Min Severity</strong></label>
                    <input type="number" id="min-severity" class="form-control" value="0" min="0" max="1" step="0.1">
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>&nbsp;</strong></label>
                    <button class="btn btn-primary w-100" onclick="loadHeatmapData()">
                        <i class="bi bi-arrow-repeat"></i> Update
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Metrics Row -->
        <div class="row mb-4" id="metrics-row">
            <div class="col-md-4">
                <div class="metric-card">
                    <h3 id="total-anomalies">-</h3>
                    <p>Total Anomalies</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="max-count">-</h3>
                    <p>Peak Count (Single Cell)</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="date-range">-</h3>
                    <p>Analysis Period</p>
                </div>
            </div>
        </div>
        
        <!-- Patterns Panel -->
        <div class="patterns-panel" id="patterns-panel" style="display: none;">
            <h5>
                <i class="bi bi-lightbulb"></i>
                Identified Patterns
            </h5>
            <div id="patterns-list"></div>
        </div>
        
        <!-- Heatmap Chart -->
        <div class="chart-container">
            <canvas id="heatmap-chart"></canvas>
        </div>
        
        <!-- Back Button -->
        <div class="text-center mt-4">
            <a href="/ui/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ====================================================================
        // CONFIGURATION
        // ====================================================================
        
            // API Base URL - detect if accessed through nginx proxy or directly
            const API_BASE = window.location.port === '8001' ? '/api/v1' : '/api/analytics/api/v1';
            const API_BASE_URL = `${API_BASE}/heatmap`;
        let heatmapChart = null;
        
        // ====================================================================
        // INITIALIZATION
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('end-date').valueAsDate = endDate;
            document.getElementById('start-date').valueAsDate = startDate;
            
            // Listen for view type changes
            document.querySelectorAll('input[name="view-type"]').forEach(radio => {
                radio.addEventListener('change', loadHeatmapData);
            });
            
            // Load initial data
            loadHeatmapData();
        });
        
        // ====================================================================
        // DATA LOADING
        // ====================================================================
        
        async function loadHeatmapData() {
            try {
                // Get parameters
                const viewType = document.querySelector('input[name="view-type"]:checked').value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const minSeverity = document.getElementById('min-severity').value;
                
                // Build query string
                const params = new URLSearchParams({
                    start_date: startDate + 'T00:00:00Z',
                    end_date: endDate + 'T23:59:59Z',
                    min_severity: minSeverity
                });
                
                // Show loading
                const chartCanvas = document.getElementById('heatmap-chart');
                const ctx = chartCanvas.getContext('2d');
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                
                // Fetch data
                const endpoint = viewType === 'hourly' ? 'hourly' : 'daily';
                const response = await fetch(`${API_BASE_URL}/${endpoint}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update metrics
                updateMetrics(data);
                
                // Update patterns
                updatePatterns(data.patterns);
                
                // Draw heatmap
                drawHeatmap(data);
                
            } catch (error) {
                console.error('Error loading heatmap data:', error);
                alert('Error loading heatmap data: ' + error.message);
            }
        }
        
        // ====================================================================
        // METRICS UPDATE
        // ====================================================================
        
        function updateMetrics(data) {
            document.getElementById('total-anomalies').textContent = data.total_anomalies.toLocaleString();
            document.getElementById('max-count').textContent = data.max_count.toLocaleString();
            
            const start = new Date(data.start_date).toLocaleDateString();
            const end = new Date(data.end_date).toLocaleDateString();
            document.getElementById('date-range').textContent = `${start} - ${end}`;
        }
        
        // ====================================================================
        // PATTERNS UPDATE
        // ====================================================================
        
        function updatePatterns(patterns) {
            const patternsPanel = document.getElementById('patterns-panel');
            const patternsList = document.getElementById('patterns-list');
            
            if (patterns.length > 0) {
                patternsPanel.style.display = 'block';
                patternsList.innerHTML = patterns.map(pattern => `
                    <div class="pattern-item">
                        <i class="bi bi-info-circle"></i>
                        ${pattern}
                    </div>
                `).join('');
            } else {
                patternsPanel.style.display = 'none';
            }
        }
        
        // ====================================================================
        // HEATMAP RENDERING
        // ====================================================================
        
        function drawHeatmap(data) {
            const ctx = document.getElementById('heatmap-chart').getContext('2d');
            
            // Destroy existing chart
            if (heatmapChart) {
                heatmapChart.destroy();
            }
            
            // Transform data for Chart.js matrix
            const matrixData = data.cells.map(cell => ({
                x: cell.x,
                y: cell.y,
                v: cell.value
            }));
            
            // Create heatmap
            heatmapChart = new Chart(ctx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Anomaly Count',
                        data: matrixData,
                        backgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex]?.v || 0;
                            const intensity = value / data.max_count;
                            
                            // Color gradient from light to dark red
                            const r = 220;
                            const g = Math.floor(220 - (180 * intensity));
                            const b = Math.floor(220 - (180 * intensity));
                            
                            return `rgba(${r}, ${g}, ${b}, ${0.3 + intensity * 0.7})`;
                        },
                        borderColor: '#ccc',
                        borderWidth: 1,
                        width: ({chart}) => (chart.chartArea || {}).width / data.x_labels.length - 2,
                        height: ({chart}) => (chart.chartArea || {}).height / data.y_labels.length - 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function() {
                                    return '';
                                },
                                label: function(context) {
                                    const cell = data.cells.find(c => 
                                        c.x === context.raw.x && c.y === context.raw.y
                                    );
                                    
                                    if (cell) {
                                        return [
                                            `Machine: ${cell.x}`,
                                            `Time: ${cell.y}`,
                                            `Anomalies: ${cell.value}`,
                                            `Avg Severity: ${cell.severity_avg.toFixed(2)}`
                                        ];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: data.x_labels,
                            title: {
                                display: true,
                                text: 'Machine'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'category',
                            labels: data.y_labels,
                            title: {
                                display: true,
                                text: document.querySelector('input[name="view-type"]:checked').value === 'hourly' ? 'Hour of Day' : 'Day of Week'
                            }
                        }
                    }
                }
            });
            
            // Set chart height
            document.getElementById('heatmap-chart').style.height = Math.max(400, data.y_labels.length * 30) + 'px';
        }
    </script>
</body>
</html>