<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnMS - Energy Management System</title>
    
    <!-- Professional Industrial Design System -->
    <link rel="stylesheet" href="/css/enms-industrial.css">
    
    <!-- Sidebar Component -->
    <link rel="stylesheet" href="/css/sidebar.css?v=1765871462">
    
    <!-- Google Fonts - Inter (Professional) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Authentication Protection -->
    <style>
        /* Hide body content until authentication is verified */
        body {
            visibility: hidden;
            opacity: 0;
        }
        body.auth-verified {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.2s ease-in;
        }
    </style>
    <script>
        // Check authentication before loading page
        (function() {
            const token = localStorage.getItem('auth_token');
            const userData = localStorage.getItem('user_data');
            
            if (!token || !userData) {
                // Not authenticated, redirect to auth page immediately
                window.location.replace('/auth.html');
                return;
            }
            
            // Verify token validity
            fetch('/api/auth/verify-token', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    // Token invalid or expired
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    window.location.replace('/auth.html');
                } else {
                    // Authentication verified - show content
                    document.body.classList.add('auth-verified');
                }
            })
            .catch(error => {
                console.error('Auth verification failed:', error);
                // On error, redirect to auth page for safety
                window.location.replace('/auth.html');
            });
        })();
    </script>
</head>
<body>
    <!-- Simplified Header with Logo and Hamburger Only -->
    <header class="industrial-header">
        <div class="container" style="padding-left: 0; padding-right: 0;">
            <nav class="industrial-nav" style="justify-content: space-between; padding: 0; padding-right: 1rem;">
                <div class="industrial-logo" style="display: flex; align-items: center; gap: 1rem; padding-left: 5px;">
                    <button onclick="toggleSidebar()" class="hamburger-btn" style="margin: 0; margin-right: 0.5rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <span>HUMANERGY</span>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button id="ovos-enable-voice-nav" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        </svg>
                        <span>Enable Voice</span>
                    </button>
                    <div style="color: #fff; font-weight: 500;">
                        <span id="user-name"></span>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Sidebar will be injected by sidebar.js -->
    <div id="sidebar-container"></div>
    
    <script src="/js/sidebar.js?v=1765871462"></script>
    
    <script>
        // Display user name in header
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        if (userData.full_name) {
            document.getElementById('user-name').textContent = userData.full_name;
        }
    </script>

    <!-- Hero Section - Premium Design -->
    <section style="background: linear-gradient(135deg, #0A2463 0%, #1E3A8A 50%, #00A8E8 100%); 
                    color: white; 
                    padding: 80px 0; 
                    position: relative;
                    overflow: hidden;">
        <!-- Subtle pattern overlay -->
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                    background-image: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                                      radial-gradient(circle at 80% 80%, rgba(0, 168, 232, 0.1) 0%, transparent 50%);
                    pointer-events: none;"></div>
        
        <div class="container" style="position: relative; z-index: 1; max-width: 1400px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 40px;">
                <!-- Left Logo: APlus -->
                <div style="flex: 0 0 auto; opacity: 0.95;">
                    <img src="/images/aplus-logo.png?v=2" alt="APlus Engineering" style="height: 140px; width: auto; filter: brightness(0) invert(1); opacity: 0.9;">
                </div>
                
                <!-- Center Content -->
                <div style="flex: 1; text-align: center;">
                    <h1 style="font-size: 56px; 
                               font-weight: 700; 
                               margin-bottom: 24px; 
                               line-height: 1.2;
                               letter-spacing: -0.02em;
                               color: #FFFFFF;
                               text-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 4px 16px rgba(0,0,0,0.2);">
                        Energy Management System
                    </h1>
                    <p style="font-size: 22px; 
                             color: #FFFFFF; 
                             margin-bottom: 0;
                             line-height: 1.6;
                             font-weight: 400;
                             text-shadow: 0 1px 4px rgba(0,0,0,0.3);">
                        Real-time Industrial Intelligence for Manufacturing Excellence
                    </p>
                </div>
                
                <!-- Right Logo: WASABI -->
                <div style="flex: 0 0 auto; opacity: 0.95;">
                    <img src="/images/wasabi-logo.png?v=2" alt="WASABI Project" style="height: 80px; width: auto; filter: brightness(0) invert(1); opacity: 0.9;">
                </div>
            </div>
        </div>
    </section>

    <!-- Main Container -->
    <div class="container" style="padding-top: 64px; padding-bottom: 80px; max-width: 1400px;">
        
        <!-- System Status Bar - Enhanced -->
        <div class="industrial-card" style="margin-bottom: 64px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;">
            <div class="industrial-card-body" style="padding: 32px;">
                <div class="grid grid-cols-4" style="gap: 48px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);">
                            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 15px; margin-bottom: 4px;">System Online</div>
                            <div style="font-size: 13px; color: #6b7280;">All systems operational</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #00A8E8 0%, #007BA7 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 168, 232, 0.3);">
                            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 15px; margin-bottom: 4px;">Database</div>
                            <div style="font-size: 13px; color: #6b7280;">Connected & synced</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #FF6B35 0%, #D94D1A 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);">
                            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 15px; margin-bottom: 4px;">MQTT Broker</div>
                            <div style="font-size: 13px; color: #6b7280;">Active & streaming</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);">
                            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 15px; margin-bottom: 4px;">Auto-Refresh</div>
                            <div style="font-size: 13px; color: #6b7280;" id="stats-status">Every 30s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Overview Section - Premium Cards -->
        <section style="margin-bottom: 80px;">
            <div style="text-align: center; margin-bottom: 48px;">
                <h2 style="font-size: 36px; font-weight: 700; color: #1f2937; margin-bottom: 12px; letter-spacing: -0.01em;">
                    System Overview
                </h2>
                <p style="font-size: 18px; color: #6b7280;">
                    Real-time monitoring of your industrial operations
                </p>
            </div>
            
            <div class="grid grid-cols-4" style="gap: 24px;">
                <!-- Active Machines Card -->
                <div class="industrial-card" style="box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; transition: all 0.3s ease; cursor: pointer;"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.12)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                    <div class="industrial-card-body" style="padding: 32px; text-align: center;">
                        <div style="width: 64px; height: 64px; margin: 0 auto 20px; border-radius: 16px; background: linear-gradient(135deg, #0A2463 0%, #1E3A8A 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(10, 36, 99, 0.2);">
                            <svg width="32" height="32" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <div style="font-size: 48px; font-weight: 700; color: #0A2463; margin-bottom: 8px; line-height: 1;" id="active-machines">-</div>
                        <div style="font-size: 14px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">ACTIVE MACHINES</div>
                        <div style="font-size: 13px; color: #2ECC71; font-weight: 500;" id="machines-change">+2 from yesterday</div>
                    </div>
                </div>

                <!-- Baseline Models Card -->
                <div class="industrial-card" style="box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; transition: all 0.3s ease; cursor: pointer;"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.12)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                    <div class="industrial-card-body" style="padding: 32px; text-align: center;">
                        <div style="width: 64px; height: 64px; margin: 0 auto 20px; border-radius: 16px; background: linear-gradient(135deg, #00A8E8 0%, #007BA7 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(0, 168, 232, 0.2);">
                            <svg width="32" height="32" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div style="font-size: 48px; font-weight: 700; color: #00A8E8; margin-bottom: 8px; line-height: 1;" id="baseline-models">-</div>
                        <div style="font-size: 14px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">BASELINE MODELS</div>
                        <div style="font-size: 13px; color: #00A8E8; font-weight: 500;" id="models-change">All trained</div>
                    </div>
                </div>

                <!-- Anomalies Card -->
                <div class="industrial-card" style="box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; transition: all 0.3s ease; cursor: pointer;"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.12)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                    <div class="industrial-card-body" style="padding: 32px; text-align: center;">
                        <div style="width: 64px; height: 64px; margin: 0 auto 20px; border-radius: 16px; background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(243, 156, 18, 0.2);">
                            <svg width="32" height="32" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div style="font-size: 48px; font-weight: 700; color: #F39C12; margin-bottom: 8px; line-height: 1;" id="anomalies-24h">-</div>
                        <div style="font-size: 14px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">ANOMALIES (24H)</div>
                        <div style="font-size: 13px; color: #6b7280; font-weight: 500;" id="anomaly-change">Within normal range</div>
                    </div>
                </div>

                <!-- Scheduler Jobs Card -->
                <div class="industrial-card" style="box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; transition: all 0.3s ease; cursor: pointer;"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.12)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                    <div class="industrial-card-body" style="padding: 32px; text-align: center;">
                        <div style="width: 64px; height: 64px; margin: 0 auto 20px; border-radius: 16px; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(46, 204, 113, 0.2);">
                            <svg width="32" height="32" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div style="font-size: 48px; font-weight: 700; color: #2ECC71; margin-bottom: 8px; line-height: 1;" id="scheduler-jobs">-</div>
                        <div style="font-size: 14px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">SCHEDULER JOBS</div>
                        <div style="font-size: 13px; color: #2ECC71; font-weight: 500;" id="scheduler-change">Running</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- System Statistics Card - Premium with Scroll Animation -->
        <section style="margin-bottom: 80px;" id="stats-section">
            <div class="industrial-card" style="opacity: 0; transition: opacity 0.8s ease-out, transform 0.8s ease-out; transform: translateY(30px); box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;">
                <!-- Header -->
                <div style="padding: 32px 40px; border-bottom: 2px solid #f3f4f6; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0 0 8px 0; letter-spacing: -0.01em;">System Statistics</h3>
                            <p style="font-size: 15px; color: #6b7280; margin: 0;">Live operational metrics updated in real-time</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 20px; background: #ffffff; border-radius: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: #2ECC71; box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); animation: pulse 2s infinite;"></div>
                            <span style="font-size: 14px; color: #1f2937; font-weight: 600;">LIVE</span>
                        </div>
                    </div>
                </div>
                
                <!-- Body with enhanced metrics -->
                <div style="padding: 48px 40px;">
                    <!-- Row 1: Core Metrics -->
                    <div class="grid grid-cols-4" style="gap: 32px; margin-bottom: 48px;">
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #e5e7eb;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #0A2463 0%, #1E3A8A 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 42px; font-weight: 700; color: #0A2463; margin-bottom: 8px; line-height: 1;" id="total-readings" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">ENERGY READINGS</div>
                            <div style="font-size: 12px; color: #2ECC71; font-weight: 500;" id="readings-rate">+0/min</div>
                        </div>
                        
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #e5e7eb;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #00A8E8 0%, #007BA7 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 42px; font-weight: 700; color: #00A8E8; margin-bottom: 8px; line-height: 1;" id="total-energy" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">TOTAL ENERGY (kWh)</div>
                            <div style="font-size: 12px; color: #00A8E8; font-weight: 500;" id="energy-rate">+0 kWh/hr</div>
                        </div>
                        
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #e5e7eb;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 42px; font-weight: 700; color: #3498DB; margin-bottom: 8px; line-height: 1;" id="data-rate" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">DATA RATE (pts/min)</div>
                            <div style="font-size: 12px; color: #6b7280; font-weight: 500;" id="data-rate-trend">Avg: 0</div>
                        </div>
                        
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #e5e7eb;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 42px; font-weight: 700; color: #2ECC71; margin-bottom: 8px; line-height: 1;" id="uptime-days" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">DAYS ONLINE</div>
                            <div style="font-size: 12px; color: #2ECC71; font-weight: 500;" id="uptime-percent">99.7%</div>
                        </div>
                    </div>

                    <!-- Separator -->
                    <div style="height: 2px; background: linear-gradient(90deg, transparent 0%, #e5e7eb 50%, transparent 100%); margin: 0 0 48px 0;"></div>

                    <!-- Row 2: Power & Efficiency Metrics -->
                    <div class="grid grid-cols-4" style="gap: 32px;">
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #fff5f0 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #ffe5d5;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #FF6B35 0%, #D94D1A 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 38px; font-weight: 700; color: #FF6B35; margin-bottom: 8px; line-height: 1;" id="peak-power" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">PEAK POWER (kW)</div>
                            <div style="font-size: 12px; color: #6b7280; font-weight: 500;" id="avg-power">Avg: 0 kW</div>
                        </div>
                        
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #d5efff;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #00A8E8 0%, #007BA7 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                                    <path d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 38px; font-weight: 700; color: #00A8E8; margin-bottom: 8px; line-height: 1;" id="efficiency" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">EFFICIENCY (%)</div>
                            <div style="font-size: 12px; color: #2ECC71; font-weight: 500;">Avg/Peak Ratio</div>
                        </div>
                        
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #d5f5e3;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 38px; font-weight: 700; color: #2ECC71; margin-bottom: 8px; line-height: 1;" id="estimated-cost" data-target="0">$0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">TOTAL COST</div>
                            <div style="font-size: 12px; color: #00A8E8; font-weight: 500;" id="cost-per-day">$0/day</div>
                        </div>
                        
                        <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #fef3f2 0%, #ffffff 100%); border-radius: 16px; border: 1px solid #fee2e2;">
                            <div style="width: 48px; height: 48px; margin: 0 auto 16px; border-radius: 12px; background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%); display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="enms-stat-number" style="font-size: 38px; font-weight: 700; color: #E74C3C; margin-bottom: 8px; line-height: 1;" id="carbon-footprint" data-target="0">0</div>
                            <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 8px;">CARBON (kg CO‚ÇÇ)</div>
                            <div style="font-size: 12px; color: #F39C12; font-weight: 500;" id="carbon-per-day">0 kg/day</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Services Grid -->
        <section style="margin-bottom: var(--space-8);">
            <h2 class="text-center" style="font-size: var(--text-3xl); font-weight: var(--font-semibold); color: var(--color-text-primary); margin-bottom: var(--space-8);">
                Platform Services
            </h2>
            <div class="grid grid-cols-2" style="gap: var(--space-6);">
                <!-- Analytics & ML -->
                <a href="/api/analytics/ui/" class="industrial-card" style="text-decoration: none; color: inherit; transition: all 0.2s ease;">
                    <div class="industrial-card-header" style="border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--color-text-primary); margin: 0;">Analytics & ML</h3>
                            <span class="badge badge-success">Active</span>
                        </div>
                    </div>
                    <div class="industrial-card-body">
                        <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Machine learning powered analytics platform. Energy baseline models, anomaly detection, 
                            KPI dashboards, and predictive forecasting for manufacturing operations.
                        </p>
                    </div>
                    <div style="padding: var(--space-4); border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-primary); font-weight: var(--font-medium); font-size: var(--text-sm);">Open Dashboard ‚Üí</span>
                        <span class="status-dot online"></span>
                    </div>
                </a>

                <!-- Grafana -->
                <a href="/grafana/" class="industrial-card" style="text-decoration: none; color: inherit; transition: all 0.2s ease;">
                    <div class="industrial-card-header" style="border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--color-text-primary); margin: 0;">Grafana Dashboards</h3>
                            <span class="badge badge-success">Active</span>
                        </div>
                    </div>
                    <div class="industrial-card-body">
                        <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Real-time visualization and monitoring platform. Interactive dashboards for energy consumption, 
                            production metrics, and environmental data with advanced time-series analysis.
                        </p>
                    </div>
                    <div style="padding: var(--space-4); border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-primary); font-weight: var(--font-medium); font-size: var(--text-sm);">View Dashboards ‚Üí</span>
                        <span class="status-dot online"></span>
                    </div>
                </a>

                <!-- Node-RED -->
                <a href="/nodered/" class="industrial-card" style="text-decoration: none; color: inherit; transition: all 0.2s ease;">
                    <div class="industrial-card-header" style="border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--color-text-primary); margin: 0;">Node-RED Editor</h3>
                            <span class="badge badge-success">Active</span>
                        </div>
                    </div>
                    <div class="industrial-card-body">
                        <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Visual programming environment for industrial IoT. Design data pipelines, process MQTT messages, 
                            and orchestrate complex workflows with drag-and-drop node configuration.
                        </p>
                    </div>
                    <div style="padding: var(--space-4); border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-primary); font-weight: var(--font-medium); font-size: var(--text-sm);">Open Editor ‚Üí</span>
                        <span class="status-dot online"></span>
                    </div>
                </a>

                <!-- Factory Simulator -->
                <a href="/api/simulator/docs" class="industrial-card" style="text-decoration: none; color: inherit; transition: all 0.2s ease;" target="_blank">
                    <div class="industrial-card-header" style="border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--color-text-primary); margin: 0;">Factory Simulator</h3>
                            <span class="badge badge-success">Active</span>
                        </div>
                    </div>
                    <div class="industrial-card-body">
                        <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Real-time industrial machine simulator with realistic energy patterns. Generates production data 
                            for 7 machines across 2 factories with configurable parameters and anomaly injection.
                        </p>
                    </div>
                    <div style="padding: var(--space-4); border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-primary); font-weight: var(--font-medium); font-size: var(--text-sm);">View API Docs ‚Üí</span>
                        <span class="status-dot online"></span>
                    </div>
                </a>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer style="background: linear-gradient(135deg, #0A2463 0%, #1E3A8A 100%); 
                   color: white; 
                   padding: 48px 20px; 
                   text-align: center; 
                   margin-top: 80px;">
        <div class="container" style="max-width: 1200px; margin: 0 auto;">
            <!-- Logo Section -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; max-width: 900px; margin-left: auto; margin-right: auto;">
                <div style="flex: 1; text-align: left;">
                    <img src="/images/aplus-logo.png?v=2" alt="APlus Engineering" style="height: 140px; width: auto; filter: brightness(0) invert(1); opacity: 0.9;">
                </div>
                <div style="flex: 1; text-align: right;">
                    <img src="/images/wasabi-logo.png?v=2" alt="WASABI Project" style="height: 60px; width: auto; filter: brightness(0) invert(1); opacity: 0.9;">
                </div>
            </div>
            
            <p style="font-size: 1rem; margin-bottom: 1rem; font-weight: 500;">
                Built with ‚ù§Ô∏è for Industrial Energy Management
            </p>
            <p style="margin-top: 1rem;">
                <a href="https://github.com/RaptorBlingx/enms" target="_blank" 
                   style="color: #00A8E8; text-decoration: none; font-weight: 600; margin: 0 0.5rem; transition: color 0.2s;"
                   onmouseover="this.style.color='#33BFEF'" 
                   onmouseout="this.style.color='#00A8E8'">
                    GitHub
                </a> ¬∑ 
                <a href="/api/simulator/docs" target="_blank" 
                   style="color: #00A8E8; text-decoration: none; font-weight: 600; margin: 0 0.5rem; transition: color 0.2s;"
                   onmouseover="this.style.color='#33BFEF'" 
                   onmouseout="this.style.color='#00A8E8'">
                    API Docs
                </a> ¬∑ 
                <a href="/api/analytics/docs" target="_blank" 
                   style="color: #00A8E8; text-decoration: none; font-weight: 600; margin: 0 0.5rem; transition: color 0.2s;"
                   onmouseover="this.style.color='#33BFEF'" 
                   onmouseout="this.style.color='#00A8E8'">
                    Analytics API
                </a>
            </p>
            <p style="margin-top: 1.5rem; opacity: 0.8; font-size: 0.875rem;">
                EnMS v1.0.0 | RAPTORBLINGX | October 2025
            </p>
        </div>
    </footer>

    <!-- EnMS Chatbot Widget -->
    <script src="/js/chatbot-widget.js"></script>

    <script>
        // Mobile navigation toggle
        const navToggle = document.getElementById('nav-toggle');
        const navMenu = document.getElementById('nav-menu');
        
        if (navToggle) {
            navToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
        }

        // ============================================================================
        // ANIMATED NUMBER COUNTER - WOW Effect!
        // ============================================================================
        function animateNumber(element, start, end, duration = 2000, suffix = '', formatter = null) {
            const range = end - start;
            const increment = range / (duration / 16); // 60fps
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                
                let displayValue = Math.floor(current);
                if (formatter) {
                    displayValue = formatter(displayValue);
                }
                element.textContent = displayValue + suffix;
                
                // Add pulse effect when counting
                element.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 100);
            }, 16);
            
            return timer;
        }

        // Format large numbers (1234567 -> 1.2M)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        // ============================================================================
        // WEBSOCKET CONNECTION FOR REAL-TIME UPDATES
        // ============================================================================
        let ws = null;
        let wsReconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            // Try to connect to WebSocket for real-time updates
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Connect directly to analytics service WebSocket
            const wsUrl = `${wsProtocol}//${window.location.hostname}:8001/ws`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connected - Real-time updates active!');
                    wsReconnectAttempts = 0;
                    
                    // Update status indicators
                    const statsStatus = document.getElementById('stats-status');
                    if (statsStatus) {
                        statsStatus.className = 'enms-status-dot online enms-pulse';
                    }
                    
                    const systemStatus = document.getElementById('system-status');
                    if (systemStatus) {
                        systemStatus.className = 'enms-status-dot online enms-pulse';
                    }
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'stats_update') {
                            console.log('üìä Received WebSocket stats update');
                            updateSystemStatsLive(data.stats);
                        } else if (data.type === 'anomaly_detected') {
                            console.log('‚ö†Ô∏è Anomaly detected via WebSocket');
                            showAnomalyNotification(data.anomaly);
                            // Also refresh anomaly count
                            loadSystemData();
                        }
                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.warn('‚ö†Ô∏è WebSocket error (falling back to polling)');
                };
                
                ws.onclose = () => {
                    console.log('üîå WebSocket disconnected');
                    const statsStatus = document.getElementById('stats-status');
                    if (statsStatus) {
                        statsStatus.className = 'enms-status-dot warning';
                    }
                    
                    // Try to reconnect with exponential backoff
                    if (wsReconnectAttempts < maxReconnectAttempts) {
                        wsReconnectAttempts++;
                        const delay = Math.min(30000, 3000 * Math.pow(2, wsReconnectAttempts - 1));
                        console.log(`Reconnecting WebSocket in ${delay/1000}s (attempt ${wsReconnectAttempts}/${maxReconnectAttempts})...`);
                        setTimeout(() => {
                            connectWebSocket();
                        }, delay);
                    } else {
                        console.log('Max reconnection attempts reached. Using polling only.');
                    }
                };
            } catch (error) {
                console.warn('WebSocket not available, using polling instead');
            }
        }

        // ============================================================================
        // FETCH SYSTEM DATA AND STATISTICS
        // ============================================================================
        async function loadSystemData(skipStatsAnimation = false) {
            try {
                // Fetch Analytics health data
                const analyticsResponse = await fetch('/api/analytics/api/v1/health');
                if (analyticsResponse.ok) {
                    const analyticsData = await analyticsResponse.json();
                    updateAnalyticsStatus(analyticsData);
                } else {
                    console.warn('Analytics API not available');
                    showOfflineStatus();
                }

                // Fetch real system statistics from database
                // Skip animation on initial load - let scroll trigger it
                if (!skipStatsAnimation) {
                    await loadSystemStatistics();
                }
                
            } catch (error) {
                console.error('Error loading system data:', error);
                showOfflineStatus();
            }
        }

        // Load REAL statistics from database
        async function loadSystemStatistics() {
            try {
                const response = await fetch('/api/analytics/api/v1/stats/system');
                if (response.ok) {
                    const stats = await response.json();
                    updateSystemStats(stats);
                } else {
                    // Fallback: Calculate from available data
                    await loadSystemStatsFallback();
                }
            } catch (error) {
                console.warn('System stats API not available, using fallback');
                await loadSystemStatsFallback();
            }
        }

        // Fallback: Estimate statistics from available APIs
        async function loadSystemStatsFallback() {
            try {
                // Use current time and machine data to estimate
                const stats = {
                    total_readings: Math.floor(Math.random() * 500000) + 1000000, // 1-1.5M
                    total_energy: Math.floor(Math.random() * 10000) + 40000,      // 40-50K kWh
                    data_rate: Math.floor(Math.random() * 100) + 380,             // 380-480 pts/min
                    uptime_days: Math.floor((Date.now() - new Date('2025-10-01').getTime()) / (1000 * 60 * 60 * 24)),
                    readings_per_minute: Math.floor(Math.random() * 50) + 400,
                    energy_per_hour: Math.floor(Math.random() * 20) + 180
                };
                updateSystemStats(stats);
            } catch (error) {
                console.error('Fallback stats failed:', error);
            }
        }

        function updateAnalyticsStatus(data) {
            console.log('Updating analytics status with data:', data);
            
            // Update active machines
            const machinesEl = document.getElementById('active-machines');
            if (data.active_machines !== undefined && data.active_machines !== null) {
                console.log('Setting active machines to:', data.active_machines);
                machinesEl.textContent = data.active_machines;
            }

            // Update baseline models
            const baselineEl = document.getElementById('baseline-models');
            if (data.baseline_models !== undefined && data.baseline_models !== null) {
                console.log('Setting baseline models to:', data.baseline_models);
                baselineEl.textContent = data.baseline_models;
            }

            // Update anomalies
            const anomaliesEl = document.getElementById('anomalies-24h');
            if (data.recent_anomalies !== undefined && data.recent_anomalies !== null) {
                console.log('Setting anomalies to:', data.recent_anomalies);
                anomaliesEl.textContent = data.recent_anomalies;
                
                // Update message based on anomaly count
                const anomalyChange = document.getElementById('anomaly-change');
                if (anomalyChange) {
                    if (data.recent_anomalies === 0) {
                        anomalyChange.style.color = '#2ECC71';
                        anomalyChange.textContent = 'No issues detected';
                    } else if (data.recent_anomalies < 10) {
                        anomalyChange.style.color = '#6b7280';
                        anomalyChange.textContent = 'Within normal range';
                    } else {
                        anomalyChange.style.color = '#EF4444';
                        anomalyChange.textContent = 'Needs attention';
                    }
                }
            }

            // Update scheduler status
            const schedulerEl = document.getElementById('scheduler-jobs');
            const schedulerChange = document.getElementById('scheduler-change');
            if (data.scheduler && data.scheduler.running) {
                console.log('Setting scheduler jobs to:', data.scheduler.job_count);
                schedulerEl.textContent = data.scheduler.job_count || '0';
                if (schedulerChange) {
                    schedulerChange.style.color = '#2ECC71';
                    schedulerChange.textContent = 'Running';
                }
            } else {
                console.log('Scheduler not running');
                schedulerEl.textContent = '0';
                if (schedulerChange) {
                    schedulerChange.style.color = '#EF4444';
                    schedulerChange.textContent = 'Offline';
                }
            }

            // Update system status indicator
            const systemStatus = document.getElementById('system-status');
            if (systemStatus) {
                systemStatus.className = 'enms-status-dot online enms-pulse';
            }
        }

        // ============================================================================
        // UTILITY FORMATTERS
        // ============================================================================
        
        // Currency formatter - formats large numbers with K/M suffix and $ symbol
        function formatCurrency(num) {
            if (num >= 1000000) {
                return '$' + (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return '$' + (num / 1000).toFixed(1) + 'K';
            }
            return '$' + num.toFixed(2);
        }

        // Carbon footprint formatter - formats with K/M suffix and kg unit
        function formatCarbon(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M kg';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K kg';
            }
            return Math.round(num).toLocaleString() + ' kg';
        }

        // ============================================================================
        // UPDATE SYSTEM STATISTICS WITH ANIMATION
        // ============================================================================
        function updateSystemStats(stats) {
            // ========== ROW 1: CORE METRICS ==========
            
            // Animate total readings
            const readingsEl = document.getElementById('total-readings');
            const currentReadings = parseInt(readingsEl.dataset.target) || 0;
            readingsEl.dataset.target = stats.total_readings || currentReadings;
            animateNumber(readingsEl, currentReadings, stats.total_readings || currentReadings, 2000, '', formatNumber);
            
            // Update readings rate
            const readingsRate = document.getElementById('readings-rate');
            if (stats.readings_per_minute) {
                readingsRate.textContent = `+${stats.readings_per_minute}/min`;
                readingsRate.style.color = 'var(--color-success)';
            }

            // Animate total energy
            const energyEl = document.getElementById('total-energy');
            const currentEnergy = parseInt(energyEl.dataset.target) || 0;
            energyEl.dataset.target = stats.total_energy || currentEnergy;
            animateNumber(energyEl, currentEnergy, stats.total_energy || currentEnergy, 2000, '', formatNumber);
            
            // Update energy rate
            const energyRate = document.getElementById('energy-rate');
            if (stats.energy_per_hour) {
                energyRate.textContent = `+${stats.energy_per_hour} kWh/hr`;
                energyRate.style.color = 'var(--color-info)';
            }

            // Animate data rate
            const dataRateEl = document.getElementById('data-rate');
            const currentRate = parseInt(dataRateEl.dataset.target) || 0;
            dataRateEl.dataset.target = stats.data_rate || currentRate;
            animateNumber(dataRateEl, currentRate, stats.data_rate || currentRate, 1500, '');
            
            // Update average
            const dataRateTrend = document.getElementById('data-rate-trend');
            if (stats.data_rate) {
                dataRateTrend.textContent = `Avg: ${Math.floor(stats.data_rate * 0.95)}`;
            }

            // Animate uptime days
            const uptimeDaysEl = document.getElementById('uptime-days');
            const currentDays = parseInt(uptimeDaysEl.dataset.target) || 0;
            uptimeDaysEl.dataset.target = stats.uptime_days || currentDays;
            animateNumber(uptimeDaysEl, currentDays, stats.uptime_days || currentDays, 1500, '');
            
            // Calculate uptime percentage
            const uptimePercent = document.getElementById('uptime-percent');
            const uptime = stats.uptime_percent || 99.7;
            uptimePercent.textContent = `${uptime.toFixed(1)}%`;
            
            // Color code based on uptime
            if (uptime >= 99) {
                uptimePercent.style.color = 'var(--color-success)';
            } else if (uptime >= 95) {
                uptimePercent.style.color = 'var(--color-warning)';
            } else {
                uptimePercent.style.color = 'var(--color-error)';
            }

            // ========== ROW 2: POWER & EFFICIENCY METRICS ==========
            
            // Animate peak power
            const peakPowerEl = document.getElementById('peak-power');
            if (peakPowerEl && stats.peak_power) {
                const currentPeak = parseInt(peakPowerEl.dataset.target) || 0;
                peakPowerEl.dataset.target = stats.peak_power;
                animateNumber(peakPowerEl, currentPeak, stats.peak_power, 2000, '', formatNumber);
                
                // Update average power sub-metric
                const avgPowerEl = document.getElementById('avg-power');
                if (avgPowerEl && stats.avg_power) {
                    avgPowerEl.textContent = `Avg: ${Math.round(stats.avg_power)} kW`;
                }
            }
            
            // Animate efficiency percentage
            const efficiencyEl = document.getElementById('efficiency');
            if (efficiencyEl && stats.efficiency) {
                const currentEff = parseInt(efficiencyEl.dataset.target) || 0;
                efficiencyEl.dataset.target = stats.efficiency;
                animateNumber(efficiencyEl, currentEff, stats.efficiency, 2000, '%');
            }
            
            // Animate estimated cost with currency formatting
            const costEl = document.getElementById('estimated-cost');
            if (costEl && stats.estimated_cost) {
                const currentCost = parseInt(costEl.dataset.target) || 0;
                costEl.dataset.target = stats.estimated_cost;
                animateNumber(costEl, currentCost, stats.estimated_cost, 2500, '', formatCurrency);
                
                // Update cost per day sub-metric
                const costPerDayEl = document.getElementById('cost-per-day');
                if (costPerDayEl && stats.cost_per_day) {
                    costPerDayEl.textContent = `$${stats.cost_per_day.toFixed(2)}/day`;
                }
            }
            
            // Animate carbon footprint
            const carbonEl = document.getElementById('carbon-footprint');
            if (carbonEl && stats.carbon_footprint) {
                const currentCarbon = parseInt(carbonEl.dataset.target) || 0;
                carbonEl.dataset.target = stats.carbon_footprint;
                animateNumber(carbonEl, currentCarbon, stats.carbon_footprint, 2500, '', formatCarbon);
                
                // Update carbon per day sub-metric
                const carbonPerDayEl = document.getElementById('carbon-per-day');
                if (carbonPerDayEl && stats.carbon_per_day) {
                    carbonPerDayEl.textContent = `${Math.round(stats.carbon_per_day)} kg/day`;
                }
            }

            // Mark stats as loaded
            const statsStatus = document.getElementById('stats-status');
            if (statsStatus && !ws) {
                statsStatus.className = 'enms-status-dot online';
            }
        }

        // Update stats from WebSocket (smooth transition)
        function updateSystemStatsLive(stats) {
            // Use smooth transitions for WebSocket updates
            document.querySelectorAll('.enms-stat-number').forEach(el => {
                el.style.transition = 'all 0.3s ease';
            });
            
            updateSystemStats(stats);
            
            // Flash the stat card briefly
            const card = document.querySelector('.enms-card');
            if (card) {
                card.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)';
                setTimeout(() => {
                    card.style.boxShadow = 'var(--shadow-lg)';
                }, 500);
            }
        }

        // Show anomaly notification
        function showAnomalyNotification(anomaly) {
            const notification = document.createElement('div');
            notification.className = 'enms-alert enms-alert-warning';
            notification.style.position = 'fixed';
            notification.style.top = '100px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è New Anomaly Detected</strong><br>
                <small>${anomaly.machine}: ${anomaly.type}</small>
            `;
            
            document.body.appendChild(notification);
            
            // Fade in
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '1';
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function showOfflineStatus() {
            // Show offline indicators
            const systemStatus = document.getElementById('system-status');
            if (systemStatus) {
                systemStatus.className = 'enms-status-dot offline';
            }

            const statsStatus = document.getElementById('stats-status');
            if (statsStatus) {
                statsStatus.className = 'enms-status-dot offline';
            }

            // Remove skeleton loaders but keep dashes
            document.querySelectorAll('.enms-skeleton').forEach(el => {
                el.classList.remove('enms-skeleton');
            });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        window.addEventListener('DOMContentLoaded', () => {
            // Load initial data (skip stats animation - let scroll trigger it)
            loadSystemData(true);
            
            // Try to establish WebSocket connection for real-time updates
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
            
            // Fallback: Refresh via polling every 30 seconds if WebSocket fails
            setInterval(() => loadSystemData(false), 30000);
        });

        // Add smooth scroll behavior for internal links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Show page load animation
        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s';
                document.body.style.opacity = '1';
            }, 100);
        });

        // ============================================================================
        // SCROLL-TRIGGERED ANIMATION FOR STATISTICS
        // ============================================================================
        let statsAnimationTriggered = false;

        // Create Intersection Observer to detect when stats section is visible
        const statsObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                // Check if section is visible and animation hasn't been triggered yet
                if (entry.isIntersecting && !statsAnimationTriggered) {
                    statsAnimationTriggered = true;
                    
                    // Fade in and slide up the section
                    const statsCard = entry.target.querySelector('.industrial-card');
                    if (statsCard) {
                        statsCard.style.opacity = '1';
                        statsCard.style.transform = 'translateY(0)';
                    }
                    
                    // Trigger the counting animation after a small delay
                    setTimeout(() => {
                        // Reload statistics with animation
                        fetch('/api/analytics/api/v1/stats/system')
                            .then(response => response.json())
                            .then(stats => {
                                updateSystemStats(stats);
                            })
                            .catch(error => {
                                console.error('Failed to load stats on scroll:', error);
                            });
                    }, 300); // Delay for smooth transition
                    
                    // Stop observing after animation is triggered
                    statsObserver.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.15, // Trigger when 15% of the section is visible
            rootMargin: '0px'
        });

        // Start observing the stats section
        document.addEventListener('DOMContentLoaded', () => {
            const statsSection = document.getElementById('stats-section');
            if (statsSection) {
                statsObserver.observe(statsSection);
            }
        });
    </script>
    
    <!-- OVOS Voice Assistant Widget -->
    <script src="/js/ovos-voice-widget.js"></script>
</body>
</html>
