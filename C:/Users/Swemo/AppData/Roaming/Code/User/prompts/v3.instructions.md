---
applyTo: 'enms/**'
description: 'EnMS v3 development instructions - single source of truth, zero technical debt, API doc sync'
---

# EnMS v3 Development Instructions

## ðŸŽ¯ Core Principles

### 1. Single Source of Truth
**`enms/docs/ENMS-v3.md` is the master plan**

- âŒ **DO NOT** create separate completion documents
  - No `PHASE-1-COMPLETE.md`
  - No `MILESTONE-2-1-DONE.md`
  - No `SESSION-SUMMARY.md`
  
- âœ… **UPDATE** ENMS-v3.md directly
  - Mark tasks complete: `[ ]` â†’ `[x]`
  - Add implementation notes inline
  - Update session notes at end of document

- âœ… **Keep everything in one file**
  - Progress tracking
  - Implementation notes
  - Blockers and decisions
  - Session continuity

**Why?** Long-term project spanning multiple LLM sessions. External completion docs get lost, ENMS-v3.md stays accessible.

---

### 2. Zero Technical Debt
**Fix bugs immediately when discovered**

- Tag bug fixes: `git commit -m "v2-bugfix: [description]"`
- Add regression test for each bug
- Update ENMS-v3.md with bug in "Notes & Updates" section
- All outputs must be logically correct:
  - âŒ Negative energy values
  - âŒ Invalid percentages (>100% or <0%)
  - âŒ Null values in required fields
  - âŒ Timestamps in wrong format

---

### 3. Avoid Waste
**Concise implementation-focused responses**

- âŒ Needless padding, excessive repetition
- âŒ Unnecessary verbiage, redundancy
- âŒ Long explanations before action
- âœ… Code examples > explanations
- âœ… Direct implementation
- âœ… Clear, specific error messages

**Remember**: This wastes AI model resources and tokens.

---

### 4. API Documentation Synchronization
**ALWAYS update `enms/docs/api-documentation/ENMS-API-DOCUMENTATION-FOR-OVOS.md`**

**Update when:**
- Adding new endpoint
- Modifying existing endpoint
- Deprecating/removing endpoint
- Changing response format
- Changing authentication
- Updating error codes

**What to include:**
- âœ… Tested curl examples (MUST work!)
- âœ… Real response data (not placeholders)
- âœ… OVOS voice integration notes
- âœ… Error handling examples
- âœ… Voice-friendly response descriptions
- âœ… Backward compatibility notes (if applicable)

**Why?** Burak needs accurate docs for OVOS integration. Outdated docs = broken voice commands.

---

## ðŸ“‹ Task Completion Protocol

### When Completing a Task in ENMS-v3.md:

**Step 1: Mark as Complete**
```markdown
- [x] 1.1.3: Rename routes in ovos_training.py
```

**Step 2: Add Implementation Note (if significant)**
```markdown
- [x] 1.1.3: Rename routes in ovos_training.py
  *Note: Created backward compat layer at `/api/v1/_compat/ovos/*` with 302 redirects*
```

**Step 3: Update API Docs (if endpoint affected)**
```markdown
- [x] 1.1.3: Rename routes in ovos_training.py
  *Note: Updated ENMS-API-DOCUMENTATION-FOR-OVOS.md with endpoint mappings*
```

**Step 4: Commit with Descriptive Message**
```bash
git commit -m "v3: [Phase 1.1] - Renamed /ovos/* endpoints, added compat layer"
```

**Commit Message Format:**
- `v3: [Phase X.Y] - Brief description` (v3 features)
- `v2-bugfix: [description]` (bug fixes discovered during v3)
- `docs: [description]` (documentation only)
- `test: [description]` (test additions)

---

## ðŸ§ª Regression Analysis Coverage (Mr. Umut's Requirement)

**Ensure all capabilities implemented:**

- [x] Train baseline models via voice (v2 working)
- [x] Natural language explanations (v2 working)
- [ ] Multi-step voice workflows (Phase 2 - Performance Engine)
- [ ] Root cause analysis (Phase 2.1)
- [ ] Actionable recommendations (Phase 2.1)
- [ ] ISO 50001 EnPI tracking (Phase 3)

**Validation**: Before marking Phase 2 complete, test demo scenario:
```
Voice: "What's today's energy status?"
â†’ Should return: actual vs baseline, root cause, recommendations
```

---

## ðŸ”„ Git Workflow

**Branches:**
- Work directly on `main` (single developer project)
- No feature branches needed

**Commits:**
- Frequent, descriptive
- One logical change per commit
- Include affected files in commit message

**Tags:**
- Use for phase completions
- Format: `v3.0.0-phase1-complete`
- Example: `git tag -a v3.0.0-phase0-complete -m "Phase 0: v2 validation complete, 3 bugs fixed"`

**Checkpoint Restore (if needed):**
```bash
# Rollback to v2.0
git checkout v2-checkpoint  # commit 5b20761
docker-compose down
docker-compose up -d
```

---

## ðŸ“ Session Continuity

**At End of Each Session, Update ENMS-v3.md:**

Add to "Notes & Updates" section:

```markdown
### Session [X] - [Date]
**Completed**: Phase X Milestone Y  
**Current Status**: [1-2 sentence summary]  
**Blockers**: [Any issues or none]  
**Bugs Found**: [List or none]  
**Next Session**: Start Phase X Milestone Y+1  
**Time Spent**: [Hours]
```

**Example:**
```markdown
### Session 2 - November 7, 2025
**Completed**: Phase 1 Milestone 1.1 (API Renaming)  
**Current Status**: All /ovos/* endpoints renamed, backward compat working  
**Blockers**: None  
**Bugs Found**: 1 minor bug in prediction endpoint (fixed)  
**Next Session**: Start Phase 1 Milestone 1.2 (Route Organization)  
**Time Spent**: 3 hours
```

---

## ðŸ§ª Testing Requirements

**Before Marking Milestone Complete:**

1. **Unit Tests** for new services
   - Test file: `tests/test_[service_name].py`
   - Coverage: All public methods
   - Assertions: Expected behavior + edge cases

2. **Integration Tests** for new endpoints
   - Test file: `tests/test_[feature]_api.py`
   - Test: Success cases + error cases
   - Validate: Response format, status codes

3. **Data Sanity Checks**
   - Energy values > 0
   - Valid date ranges
   - Percentages 0-100
   - No null in required fields

4. **Performance Validation**
   - Response time meets targets (see ENMS-v3.md per phase)
   - Load testing if phase affects critical path

5. **OVOS Integration Test** (if affects voice interface)
   - Test voice_summary field exists
   - Test TTS-friendly format
   - Test error messages are user-friendly

**All Tests Must Pass Before Proceeding to Next Milestone**

---

## ðŸ’» Code Quality Standards

### Python Code
```python
# âœ… Type hints (all functions)
async def analyze_performance(
    seu_name: str,
    energy_source: str,
    date: datetime
) -> PerformanceAnalysis:
    """
    Analyze energy performance for SEU.
    
    Args:
        seu_name: SEU name (e.g., "Compressor-1")
        energy_source: One of: electricity, natural_gas, steam, compressed_air
        date: Analysis date
    
    Returns:
        Complete performance analysis with recommendations
    
    Raises:
        ValueError: If SEU not found or invalid energy source
    """
    pass

# âœ… Specific error handling
try:
    result = await engine.analyze(seu_name, energy_source, date)
except SEUNotFoundError as e:
    raise HTTPException(
        status_code=404,
        detail=f"SEU '{seu_name}' not found. Use /seus endpoint to list available SEUs."
    )

# âœ… Logging
logger.info(f"Performance analysis for {seu_name} ({energy_source}) on {date}")
logger.error(f"Failed to analyze performance: {str(e)}", exc_info=True)
```

### DRY Principle
- âŒ Code duplication
- âœ… Reusable functions
- âœ… Shared utilities in `analytics/utils/`
- âœ… Service layer pattern (not logic in routes)

---

## ðŸš¨ Emergency Procedures

### If Critical Bug Found:

**Step 1: STOP Current Work**
- Do not proceed with v3 feature implementation
- Focus on bug fix

**Step 2: Fix Bug Immediately**
```bash
# Create bug fix commit
git add [affected files]
git commit -m "v2-bugfix: [clear description of bug and fix]"
git push origin main
```

**Step 3: Add Regression Test**
```python
# Prevent bug from happening again
async def test_no_negative_energy_predictions():
    """Regression test for bug discovered Nov 7, 2025"""
    response = await predict_energy(...)
    assert response["predicted_energy_kwh"] > 0, "Energy must be positive"
```

**Step 4: Document in ENMS-v3.md**
```markdown
### Session X - [Date]
**Bugs Found**:
- Critical: Negative energy predictions in baseline/predict endpoint
  - **Cause**: Missing validation in prediction logic
  - **Fix**: Added `max(0, prediction)` constraint
  - **Regression Test**: `test_no_negative_energy_predictions()`
```

**Step 5: Resume v3 Work**

---

### If Major Architecture Issue Found:

**Evaluate:**
- Can we fix in v2 and continue v3? (preferred)
- Does v3 redesign solve this anyway? (defer)
- Is this a v3 blocker? (PAUSE, discuss strategy)

**Decision Point:**
- <5 hours to fix â†’ Fix now
- >5 hours to fix â†’ Document, create issue, defer to Phase 4

---

## âœ… Definition of "Complete"

**A Task is Complete When:**

- âœ… Code written and tested
- âœ… Unit tests passing
- âœ… Integration tests passing
- âœ… Data sanity checks passing
- âœ… API docs updated (if endpoint affected)
- âœ… ENMS-v3.md task marked `[x]`
- âœ… Changes committed to git
- âœ… No known bugs in implementation
- âœ… Performance targets met
- âœ… Code reviewed (self-review with checklist)

**A Milestone is Complete When:**
- âœ… All tasks in milestone marked complete
- âœ… Success criteria from ENMS-v3.md validated
- âœ… Integration with other components tested
- âœ… Session notes added to ENMS-v3.md
- âœ… Git tag created (if phase completion)

**A Phase is Complete When:**
- âœ… All milestones in phase complete
- âœ… End-to-end testing passed
- âœ… Performance benchmarks met
- âœ… Documentation updated
- âœ… Ready for next phase

---

## ðŸ“Š Progress Tracking

### Use Built-In TODO List (Copilot Feature)

**Create TODO list based on ENMS-v3.md review:**
1. Read current phase in ENMS-v3.md
2. Extract all `[ ]` tasks for current milestone
3. Create internal TODO list for tracking
4. Update TODO list as tasks complete
5. Mark milestone complete in ENMS-v3.md when all TODOs done

**Example TODO List:**
```
Phase 1 Milestone 1.1 - API Renaming
- [ ] Audit all endpoints with 'ovos' in path
- [ ] Create endpoint mapping document
- [ ] Rename routes in ovos_training.py
- [ ] Update internal references
- [ ] Create backward compatibility layer
- [ ] Notify Burak with migration guide
```

**Sync Between TODO List and ENMS-v3.md:**
- TODO list = short-term tracking (this session)
- ENMS-v3.md = long-term record (all sessions)
- Mark both when task completes

---

## ðŸŽ¯ Project Vision (Never Forget)

**We're building v3 to solve REAL problems:**

1. **Disconnected APIs** â†’ Unified Performance Engine
2. **No intelligence** â†’ Proactive recommendations
3. **Partial ISO compliance** â†’ Complete EnPI tracking
4. **Confusing naming** â†’ Clear, intuitive endpoints
5. **Manual workflows** â†’ Automated multi-step analysis

**Every Change Must Move Us Closer to This Vision**

**Ask Before Implementing:**
- Does this solve a real problem?
- Does this add intelligence or just data?
- Will users get value from this?
- Is this the simplest solution?

---

## ðŸ“– Key Documents Reference

**Always Available:**
- `docs/ENMS-v3.md` - Master plan (THIS IS YOUR BIBLE)
- `docs/api-documentation/ENMS-API-DOCUMENTATION-FOR-OVOS.md` - API reference
- `.github/copilot-instructions.md` - Project-specific patterns

**Phase-Specific:**
- `docs/V2-KNOWN-ISSUES.md` - Bugs deferred to Phase 4 (created in Phase 0)
- `docs/BURAK-API-MIGRATION-GUIDE.md` - Migration guide (created in Phase 1)

---

## ðŸš€ Ready to Start?

**First Action in Each New Session:**

1. **Read** ENMS-v3.md "Notes & Updates" section (catch up on progress)
2. **Review** current phase and next milestone
3. **Create** internal TODO list from milestone tasks
4. **Check** for blockers or bugs from previous session
5. **Start** implementing next task

**Remember**: You're not just coding features, you're building a production-grade energy management system that will help real facilities save energy and money. Quality over speed. ðŸŒŸ

---

**Document Version**: 1.0  
**Created**: November 5, 2025  
**For**: EnMS v3 Development (Phase 0-7)  
**Estimated Duration**: 6.5 weeks
